---
title: "Birdwatching with Project Feederwatch"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    source_code: embed
    vertical_layout: fill
runtime: shiny
---

```{r global, include=FALSE}
library(here)
library(tidyverse)
# Load data for dashboard
# List required files to download from TidyTuesday
rds_files <- c("feederwatch.RDS")

# Check if any of these files don't exist
if (any(!file.exists(here("data", rds_files)))) {
  dir.create(here("data"))
# if missing, download the data
feederwatch <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_2021_public.csv')

# save the data objects as RDS files
saveRDS(feederwatch, file = here("data","feederwatch.RDS"))
}

# Load data
feederwatch <- readRDS(here("data","feederwatch.RDS"))

# had to save the species_codes dictionary manually from https://docs.google.com/spreadsheets/d/1kHmx2XhA2MJtEyTNMpwqTQEnoa9M7Il2/edit#gid=2040245914
species_codes_dd <- read_csv(here("data","FeederWatch_Data_Dictionary_Species_Codes.csv"),skip = 1)

# Preliminary pre-processing of data:

names(feederwatch) <- tolower(names(feederwatch))
names(species_codes_dd) <- tolower(names(species_codes_dd))

data_df <- left_join(feederwatch, species_codes_dd, by = "species_code") %>%
  filter(valid == 1,                        # remove "invalid" observations (N = 656)
         category == "species") %>%         # remove birds that weren't identified to the species level (N = 1194)
  separate_wider_delim(subnational1_code, "-", names = c("country","state/province")) %>%
  mutate(month=factor(month, levels=c("11","12","1","2","3","4"))) %>%
  select(primary_com_name, 
            sci_name, 
            country,
            `state/province`,
            latitude, 
            longitude,
            month, 
            day, 
            year, 
            how_many,
            effort_hrs_atleast,
            snow_dep_atleast)  # remove columns that probably aren't interesting to the public
# Maybe still have too many columns - may want to filter further for data table??

# Prep maps of America/USA for making figures
america_map <- map_data("world", region='USA')
USA_map <-
  ggplot(america_map, 
         aes(x=long, y=lat, group=group)) +
  geom_polygon(fill="white",color="black") + 
  scale_x_continuous(limits = c(-125,-65)) +
  scale_y_continuous(limits = c(25, 50)) + 
  coord_map() +
  theme_minimal()

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)
library(flexdashboard)
library(DT)
library(shiny)
```
# About


## Column 

**Project aims**

Let's investigate patterns in abundance and distribution of different species of birds in the 2020-21 winter in the United States and southern Canada.
Specifically, we can examine:

-   when and where are birds observed
-   which species are most common, and where are they found
-   which species tend to occur in large flocks, and where are they found

This analysis is intended for the general public, as well as the citizen scientists (and the graders for Biostat 777).


### Chart A

```{r}

```

## Column {data-width=350}

### Chart B

```{r}

```

### Chart C

```{r}

```

# Data 

## Column 
These data were discovered via [TidyTuesday for January 10, 2023](https://github.com/rfordatascience/tidytuesday/tree/master/data/2023/2023-01-10), but originally come from [Project FeederWatch](https://feederwatch.org/).
Project FeederWatch is a citizen science project that aims to engage individuals in North America to count birds (for as long or as little as they like) to track winter trends in bird distribution and abundance.
This project has been running for more than 30 years at this point!
The data dictionary is available [here](https://drive.google.com/file/d/1kHmx2XhA2MJtEyTNMpwqTQEnoa9M7Il2/view).


```{r}
DT::renderDataTable({
  DT::datatable(data_df,
                caption = htmltools::tags$caption(
                  style = 'caption-side: top; text-align: Left;'),
                options = list(autoWidth = TRUE,
                               pageLength = 10,
                               scroller = TRUE,
                               scrollY = '450px'))
})
```



# Static 1



# Static 2



# Sighting times and locations

## Column {.sidebar}

```{r}
selectInput("bird_sp", label = "Species:",
            choices = sort(unique(data_df$primary_com_name)), selected = "Abert's Towhee")

```

## Column

### Bird sightings

```{r}
month_colors = c("sandybrown","indianred","slateblue3","royalblue","palegreen3","goldenrod1")

renderPlot({
  bird_species_df <- data_df %>%
  filter(primary_com_name == input$bird_sp)
  
  ggplot(america_map, 
         aes(x=long, y=lat, group=group)) +
  geom_polygon(fill="white",color="black") + 
  scale_x_continuous(limits = c(-125,-65)) +
  scale_y_continuous(limits = c(25, 50)) + 
  coord_map() +
  theme_minimal() +
  geom_point(data = bird_species_df,
             aes(x = longitude, y = latitude, group=NULL, size=how_many, color=month), 
             alpha=0.5) +
  scale_color_manual(values=month_colors) +   
  theme_minimal() + 
  labs(x="Longitude (E)", 
       y="Latitude (N)", 
       title=paste0("Reported sightings of the ", input$bird_sp, " in the US and southern Canada in winter 2020-21"), 
       caption = "Data: Project FeederWatch",
       size="Count per observation") +
  facet_wrap(vars(primary_com_name), 
             labeller = labeller(primary_com_name = label_wrap_gen(width = 10)))
})
```



# Int 2



# Analysis

## Column



