---
title: "Birdwatching with Project Feederwatch"
output: 
  flexdashboard::flex_dashboard:
    source_code: embed
    vertical_layout: fill
    theme:
      version: 4
      bootswatch: minty
runtime: shiny
---

```{r global, include=FALSE}
library(here)
library(tidyverse)
# Load data for dashboard
# List required files to download from TidyTuesday
rds_files <- c("feederwatch.RDS")

# Check if any of these files don't exist
if (any(!file.exists(here("data", rds_files)))) {
  dir.create(here("data"))
# if missing, download the data
feederwatch <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_2021_public.csv')

# save the data objects as RDS files
saveRDS(feederwatch, file = here("data","feederwatch.RDS"))
}

# Load data
feederwatch <- readRDS(here("data","feederwatch.RDS"))

# had to save the species_codes dictionary manually from https://docs.google.com/spreadsheets/d/1kHmx2XhA2MJtEyTNMpwqTQEnoa9M7Il2/edit#gid=2040245914
species_codes_dd <- read_csv(here("data","FeederWatch_Data_Dictionary_Species_Codes.csv"),skip = 1)

# Also made a .csv of state birds from data on Wikipedia
state_bird_df <- read_csv(here("data","state_birds_list_plain.csv"))


# Preliminary pre-processing of data:

names(feederwatch) <- tolower(names(feederwatch))
names(species_codes_dd) <- tolower(names(species_codes_dd))

# Make df for state names/abbreviations 
US_state_name_abb <- as.data.frame(cbind(state_abb = state.abb, 'state/province' = state.name))
US_state_name_abb <- rbind(US_state_name_abb,c("DC","Washington, D.C."))

# CA_provinces_abb <- data_df %>%
#  filter(country=='CA') %>%
#   select('state/province') %>%
#   unique() %>%
#   arrange()

CA_province_name <- c("Quebec","Ontario","British Columbia","Manitoba","Nova Scotia","New Brunswick","Prince Edward Island","Newfoundland and Labrador","Alberta","Saskatchewan")
CA_provinces_abb <- c("QC","ON","BC","MB","NS","NB","PE","NL","AB","SK")
CA_province_name_abb <- as.data.frame(cbind(state_abb = CA_provinces_abb, 'state/province' = CA_province_name)) 

US_CA_name_abb <- rbind(US_state_name_abb, CA_province_name_abb)

# Clean data
data_df <- left_join(feederwatch, species_codes_dd, by = "species_code") %>%
  filter(valid == 1,                        # remove "invalid" observations (N = 656)
         category == "species",          # remove birds that weren't identified to the species level (N = 1194)
         latitude >= 20,
         latitude <= 50) %>%
  separate_wider_delim(subnational1_code, "-", names = c("country","state_abb")) %>%
  left_join(US_CA_name_abb, by = "state_abb") %>%
  filter(country == "US" | country == "CA") %>%
  mutate(month=factor(month, levels=c("11", "12","1","2","3","4"), labels = c("Nov", "Dec", "Jan", "Feb", "Mar", "Apr"))) %>%
  select(primary_com_name, 
            sci_name, 
            country,
            `state/province`,
            latitude, 
            longitude,
            month, 
            day, 
            year, 
            how_many)  # remove columns that probably aren't interesting to the public
# Maybe still have too many columns - may want to filter further for data table??

# Check that all US states + DC + Canadian provinces were matched correctly
# state_na_i <- which(is.na(data_df$'state/province')==1)
# data_df[head(state_na_i),]

# Prep maps of America/USA for making figures
america_map <- map_data("world", region='USA')

USA_map <-
  ggplot(america_map,
         aes(x=long, y=lat, group=group)) +
  geom_polygon(fill="white",color="black") +
  scale_x_continuous(limits = c(-125,-65)) +
  scale_y_continuous(limits = c(25, 50)) +
  coord_map() +
  theme_minimal()

states_map <- map_data("state")

# state_map <- states_map %>%
#   filter(region == "west virginia") %>%
#   ggplot(aes(x = long, y = lat)) +
#   geom_polygon(fill="white",color="black") +
#   coord_map() +
#   theme_minimal()

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)
library(flexdashboard)
library(DT)
library(shiny)
library(lemon)     # pretty tables with kable
```
# About


## Column 

**Purpose of this dashboard**  
This dashboard investigates patterns in the abundance and distribution of different species of birds in the 2020-21 winter in the United States and southern Canada. The data came from [Project FeederWatch](https://feederwatch.org/), which is a citizen science project that aims to engage individuals in North America to count birds (for as long or as little as they like) to track winter trends in bird distribution and abundance. This project has been running for more than 30 years at this point!

In this dashboard, we explore:

-   high-level overview of the observing system
-   which species were most common, and where they were found
-   species-specific distribution patterns for all observed species
-   if a state bird was observed in its own state (for fun!)

This dashboard is intended for use by the general public, as well as the citizen scientists of Project FeederWatch. 


### Chart A

```{r}

```

## Column {data-width=350}

### Chart B

```{r}

```

### Chart C

```{r}

```

# Data 

## Column 
These data were discovered and downloaded via [TidyTuesday for January 10, 2023](https://github.com/rfordatascience/tidytuesday/tree/master/data/2023/2023-01-10), but originally come from [Project FeederWatch](https://feederwatch.org/). The data dictionary is available [here](https://drive.google.com/file/d/1kHmx2XhA2MJtEyTNMpwqTQEnoa9M7Il2/view). For the purposes of this dashboard, data were filtered to focus on the continental United States and southern Canada (south of 50°N), where most observations were made. Data of questionable quality (i.e., having been identified by Project FeederWatch as being "invalid") or data that were missing critical information were omitted. A total of 96,408 unique observations were retained in this analysis.


```{r}
DT::renderDataTable({
  DT::datatable(data_df,
                caption = htmltools::tags$caption(
                  style = 'caption-side: top; text-align: Left;'),
                options = list(autoWidth = TRUE,
                               pageLength = 10,
                               scroller = TRUE,
                               scrollY = '450px'))
})

## TODO: change size of text below!!
```

# Quick facts {data-orientation=rows}

## Row

### Quick facts
- 370,672: The total number of birds reported!

- 361: The number of unique species 

- 177,522: The number of hours volunteers spent birdwatching!

- November 13, 2020: The date the first observation was made

- April 30, 2021: The date the last observation was made


## Row {data-width=250}

### Northern cardinal
![The northern cardinal was the most commonly observed species in Project FeederWatch in winter 2020-21. It is also the state bird for seven states! Photo credit: American Bird Conservancy.](northern_cardinal.jpeg){width="80%"}

### Dark-eyed junco
![The dark-eyed junco was the second most commonly observed species. <br> Photo credit: Bob Vuxinic](dark_eyed_junco_ProjectFeederwatch.png){width="80%"}

### Downy woodpecker
![The downy woodpecker was the third most commonly observed species. Photo credit: Evan Lipton](downy_woodpecker.jpeg){width="80%"}

# Common birds

## Column {.tabset}

### Top 10 most common birds
```{r , render=lemon_print}
# Table of most common birds

commonly_sighted_birds_table <- data_df %>%
  group_by(sci_name, primary_com_name) %>%
  summarize(total = sum(how_many),
            count = n()) %>%
  arrange(desc(count)) %>%
  head(n=10) %>%
  select('Common name' = primary_com_name,
         'Scientific name' = sci_name,
         'Number of observations' = count)
commonly_sighted_birds_table

```


### Sighting numbers and locations
```{r, eval=FALSE}
# Figure 4: Commonly sighted birds
# Since this figure takes a long time to render, we'll just load in the saved figure below, but this is the code that was used to generate it:
  
common_birds_plot <- USA_map +
  geom_bin_2d(data = commonly_sighted_birds_df, 
              aes(x = longitude, y = latitude, group=NULL)) +
  scale_fill_continuous(low="lightskyblue1", 
                        high="indianred4", 
                        name="Number of \nsightings") +
  theme_minimal() + 
  labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title="Observations of common birds in the US and southern Canada", 
       subtitle="Common bird species are most frequently observed in the Mid-Atlantic and \nNortheast regions, likely due (in part) to a sampling bias and easy bird identification", 
       color="Month") + 
  facet_wrap(vars(PRIMARY_COM_NAME), 
             labeller = labeller(PRIMARY_COM_NAME = label_wrap_gen(width = 10)))
#ggsave(here("figs","Commonly_sighted_birds.png"), plot=common_birds_plot, width=7, height=7, units="in")

## TODO: don't know how to center the graphic below!
```

::: {#fig-common fig-cap="Heatmap of observations for the most common birds."}
![](./figs/Commonly_sighted_birds.png){width="70%"}
:::


# Species distribution patterns

## Column {.sidebar}

Select a species to see when and where it was observed

```{r}
# Select the species you want to see
selectInput("bird_sp", label = "Species:",
            choices = sort(unique(data_df$primary_com_name)), selected = "Abert's Towhee")

# TODO: add another option for "select a month" to see which birds are where and when?

# Select the months you want to see
selectInput("month_input", label = "Month:",
            choices = c("Nov","Dec","Jan","Feb","Mar","Apr"), multiple = TRUE, selected = "Nov")


```



## Column

### Bird sightings

```{r}
month_colors_df <- data.frame(color = c("chocolate4","indianred3","slateblue2","lightblue3","palegreen3","goldenrod1"))
month_colors_df$month <- c("Nov","Dec","Jan","Feb","Mar","Apr")
  
renderPlot({
  input_month_colors <- month_colors_df %>%
    filter(month %in% input$month_input)
    
  bird_species_df <- data_df %>%
  filter(primary_com_name == input$bird_sp,
         month %in% input$month_input)
  
  ggplot(america_map, 
         aes(x=long, y=lat, group=group)) +
  geom_polygon(fill="white",color="black") + 
  scale_x_continuous(limits = c(-125,-65)) +
  scale_y_continuous(limits = c(25, 50)) + 
  coord_map() +
  theme_minimal() +
  geom_point(data = bird_species_df,
             aes(x = longitude, y = latitude, group=NULL, size=how_many, color=month), 
             alpha=0.5) +
  scale_color_manual(values=input_month_colors$color) +  
  theme_minimal() + 
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
                plot.title = element_text(size = 20),
                plot.caption = element_text(size = 18),
                legend.title =  element_text(size = 18))+ 
  labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title=paste0("Reported sightings of the ", input$bird_sp, " in winter 2020-21"), 
       caption = "Data: Project FeederWatch",
       size="Count per observation")+
  guides(color = guide_legend(override.aes = list(size=5)))
})

## TODO: add slider so we can see how the birds change over the months?

```


# State bird sightings

## Column {.sidebar}

Select a state to see its "state bird" sightings 

```{r}
# remove Alaska and Hawaii from state list (i.e., want only continental states)
continental_state.name <- state.name
cont.state.name <- continental_state.name[-c(2,11)]
selectInput("state", label = "State:",
            choices = cont.state.name, selected = "Alabama")
```

## Columm 
### State bird sightings
```{r}

renderPlot({
state_bird_sci_name <- state_bird_df %>%
  filter(state == input$state) %>%
  select(sci_name)

state_bird_com_name <- state_bird_df %>%
  filter(state == input$state) %>%
  select(primary_com_name)

state_bird_data_df <- data_df %>%
  filter(`state/province` == input$state,
         sci_name %in% state_bird_sci_name)

n_bird <- sum(state_bird_data_df$how_many)
n_obs <- nrow(state_bird_data_df)
  
if (dim(state_bird_data_df)[1] < 1){
  states_map %>%
    filter(region == tolower(input$state)) %>%
    ggplot(aes(x = long, y = lat)) +
    geom_polygon(fill="white",color="black") +
    coord_map() +
    theme_minimal() +
    labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title=paste0(input$state, ": ", state_bird_com_name, ": No sightings"))  +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
                plot.title = element_text(size = 22),
                plot.caption = element_text(size = 14)) 
  }
else {
  states_map %>%
    filter(region == tolower(input$state)) %>%
    ggplot(aes(x = long, y = lat)) +
    geom_polygon(fill="white",color="black") +
    coord_map() +
    theme_minimal() +
    geom_point(data = state_bird_data_df,
             aes(x = longitude, y = latitude), 
             size = 5,
             color = "black",
             fill = "grey80",
             pch = 21) +
  theme_minimal() + 
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
                plot.title = element_text(size = 22),
                plot.subtitle = element_text(size = 18),
                plot.caption = element_text(size = 14),
                legend.title =  element_text(size = 18)) + 
  labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title=paste0(input$state, ": ", state_bird_com_name), 
       subtitle = paste0(n_bird, " birds sighted across ", n_obs, " observations"),
       caption = "Data: Project FeederWatch") 
}
})


# TODO: Michigan and Washington (and others??) have a weird thing happening when the state gets drawn :( Fix if time!
# TODO: We have bird data from DC but don't have a way to plot it (since DC (and Alaska!) aren't included in the map_data::states - which is weird!)

```

```{r backup, eval=FALSE}

renderPlot({
state_bird_sci_name <- state_bird_df %>%
  filter(state == input$state) %>%
  select(sci_name)

state_bird_com_name <- state_bird_df %>%
  filter(state == input$state) %>%
  select(primary_com_name)

state_bird_data_df <- data_df %>%
  filter(`state/province` == input$state,
         sci_name %in% state_bird_sci_name)

n_bird <- sum(state_bird_data_df$how_many)
n_obs <- nrow(state_bird_data_df)
  
if (dim(state_bird_data_df)[1] < 1){
  states_map %>%
    filter(region == tolower(input$state)) %>%
    ggplot(aes(x = long, y = lat)) +
    geom_polygon(fill="white",color="black") +
    coord_map() +
    theme_minimal() +
    labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title=paste0(input$state, ": ", state_bird_com_name, ": No sightings"))  +
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
                plot.title = element_text(size = 22),
                plot.caption = element_text(size = 14)) 
  }
else {
  states_map %>%
    filter(region == tolower(input$state)) %>%
    ggplot(aes(x = long, y = lat)) +
    geom_polygon(fill="white",color="black") +
    coord_map() +
    theme_minimal() +
    geom_point(data = state_bird_data_df,
             aes(x = longitude, y = latitude, group=NULL, size=how_many, color=month), 
             alpha=0.5) +
  scale_color_manual(values=month_colors) +  
  theme_minimal() + 
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
                plot.title = element_text(size = 22),
                plot.caption = element_text(size = 14),
                legend.title =  element_text(size = 18))+ 
  labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title=paste0(input$state, ": ", state_bird_com_name), 
       caption = "Data: Project FeederWatch",
       size="Count per observation") +
  facet_wrap(vars(primary_com_name), 
             labeller = labeller(primary_com_name = label_wrap_gen(width = 10))) +
  guides(color = guide_legend(override.aes = list(size=6)))
}
})


# TODO: Michigan and Washington (and others??) have a weird thing happening when the state gets drawn :( Fix if time!
# TODO: We have bird data from DC but don't have a way to plot it (since DC (and Alaska!) aren't included in the map_data::states - which is weird!)

```

```{r try things out, eval=FALSE}

state_bird_sci_name <- state_bird_df %>%
  filter(state == "West Virginia") %>%
  select(sci_name)

state_bird_com_name <- state_bird_df %>%
  filter(state == "West Virginia") %>%
  select(primary_com_name)

state_bird_data_df <- data_df %>%
  filter(`state/province` == "West Virginia",
         sci_name %in% state_bird_sci_name)


state_bird_data_df <- data_df %>%
  filter(`state/province` == input$state,
         sci_name %in% state_bird_sci_name)
  
  states_map %>%
    filter(region == tolower("West Virginia")) %>%
    ggplot(aes(x = long, y = lat)) +
    geom_polygon(fill="white",color="black") +
    coord_map() +
    theme_minimal() +
    geom_point(data = state_bird_data_df,
             aes(x = longitude, y = latitude, group=NULL, size=how_many, color=month), 
             alpha=0.5) +
  scale_color_manual(values=month_colors) +  
  theme_minimal() + 
  theme(axis.text = element_text(size = 18),
        axis.title = element_text(size = 18),
                plot.title = element_text(size = 20),
                plot.caption = element_text(size = 14),
                legend.title =  element_text(size = 18))+ 
  labs(x="Longitude (°E)", 
       y="Latitude (°N)", 
       title=paste0("Reported sightings of the ", state_bird_com_name, " in ", input$state, " in winter 2020-21"), 
       caption = "Data: Project FeederWatch",
       size="Count per observation") +
  facet_wrap(vars(primary_com_name), 
             labeller = labeller(primary_com_name = label_wrap_gen(width = 10))) +
  guides(color = guide_legend(override.aes = list(size=5)))
  
  
  
  test <- feederwatch
test2 <- test %>%
    mutate(date = make_date(year, month, day))

```


# Analysis 

## Column 

### Where are the birdwatchers?

```{r}
#| fig-cap: "Observing locations for Project FeederWatch 2020-21 winter."
#| label: fig-obs-loc
# Figure 1: Map of unique sighting locations

# Identify unique sighting locations
unique_sighting_locations <- feederwatch %>%
  group_by(loc_id) %>%
  summarize(n_obs = n(),
            latitude=mean(latitude),
            longitude=mean(longitude))

# Plot unique sighting locations
USA_map +
  geom_point(data=unique_sighting_locations, 
             aes(x = longitude, y = latitude, group=NULL), 
             alpha=0.1, 
             color="darkgreen") +
  labs(x="Longitude (ºE)", 
       y = "Latitude (ºN)", 
       subtitle = "Engagement in Project Feederwatch is stronger in the eastern than the western \nU.S.; the highest density of birdwatchers are in the mid-Atlantic to Northeast regions",
       caption = "Data: Project FeederWatch")

```


## Column {data-width=400}

### Number of birds observed by latitude
```{r}
# Figure 2: Bird count per latitude band

feederwatch_lat <- feederwatch %>%
  mutate(Date = ymd(paste(year, month, day, sep="-")),
         lat_band = case_when(
           latitude < 35 ~ "low",
           latitude >=35 & latitude < 45 ~ "mid",
           latitude >= 45 ~ "high"
         )) 
feederwatch_lat$lat_band <- factor(feederwatch_lat$lat_band, levels=c("high","mid","low"))

feederwatch_lat %>%
  group_by(Date, 
           lat_band) %>%
  summarize(total = sum(how_many),
            count = n(),
            std_total = total/count) %>%
  ggplot(aes(x=Date, y = std_total, color = lat_band)) +   
  geom_smooth() +   # loess-smoother is default
  theme_minimal() +   
  labs(y = "Average number of birds per observation", 
       color = "Latitude band", 
       subtitle = "Birds are most abundant at high latitudes, but become relatively \nmore frequent in low latitudes in the winter", 
       caption = "Data: Project FeederWatch")

```


### Number of observations per species

```{r}
feederwatch %>%
  group_by(species_code) %>%
  summarize(n_obs = n()) %>%
  ggplot() +
  geom_histogram(aes(n_obs), 
                 boundary=0, 
                 closed="left") +
  labs(x = "Number of observations for a given species", 
       y = "Frequency", 
       subtitle = "Most species were only observed once. A few species were observed \nthousands of times.",
       caption = "Data: ProjectFeederwatch") +
  theme_minimal()

```


